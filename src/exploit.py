from bs4 import BeautifulSoup


def read_html_file(file_path):
    with open(file_path, "r") as file_src:
        return file_src.read()


def write_html_file(file_path, content):
    with open(file_path, "w") as file_target:
        file_target.write(content)


def modify_title(soup):
    title_tag = soup.find("title")
    title_tag.string = "Evil Corp - Stealing your money every day"


def modify_user_name(soup):
    user_tag = soup.find("span", {"class": "name"})
    if user_tag:
        user_name = user_tag.get_text()
        user_tag.replace_with(BeautifulSoup(
            f"<h1>{user_name}, you are hacked!</h1>", "lxml"))


def inject_trenton_script(soup):
    script_tag = BeautifulSoup("""
     <script>
            hacked = function() {
                alert("hacked");
            }
            window.addEventListener("load", 
              function() { 
                var f = document.querySelector("form");
                f.setAttribute("onsubmit", "hacked()");
              },
              false
        );
    </script>
    """, "lxml")

    body_tag = soup.find("body")
    body_tag.insert(1, script_tag)


def replace_link(soup):
    link_tag = soup.find(
        "a", {"href": "https://mrrobot.fandom.com/wiki/E_Corp"})
    if link_tag:
        link_tag["href"] = "https://mrrobot.fandom.com/wiki/Fsociety"
        link_tag.string = "Fsociety"


def apply_changes(html_content):
    soup = BeautifulSoup(html_content, "lxml")

    modify_title(soup)
    modify_user_name(soup)
    inject_trenton_script(soup)
    replace_link(soup)

    return soup.prettify()


if __name__ == "__main__":
    input_file_path = "../materials/evilcorp.html"
    output_file_path = "../materials/evilcorp_hacked.html"

    html_content = read_html_file(input_file_path)
    modified_content = apply_changes(html_content)
    write_html_file(output_file_path, modified_content)
